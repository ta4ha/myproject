<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>دمج ملفات Excel</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        let firstFileData = [];
        let secondFileData = [];
        let columnSet = new Set();

        document.addEventListener("DOMContentLoaded", function () {
            document.getElementById('firstFileInput').addEventListener('change', handleFirstFile);
            document.getElementById('secondFileInput').addEventListener('change', handleSecondFile);
        });

        function handleFirstFile(event) {
            const file = event.target.files[0];
            const reader = new FileReader();
            reader.onload = (e) => {
                const workbook = XLSX.read(e.target.result, { type: 'binary' });
                const sheetName = workbook.SheetNames[0];
                firstFileData = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);
                
                if (firstFileData.length > 0) {
                    Object.keys(firstFileData[0]).forEach(col => columnSet.add(col));
                }
            };
            reader.readAsBinaryString(file);
        }

        function handleSecondFile(event) {
            const file = event.target.files[0];
            const reader = new FileReader();
            reader.onload = (e) => {
                const workbook = XLSX.read(e.target.result, { type: 'binary' });
                const sheetName = workbook.SheetNames[0];
                secondFileData = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);
                
                if (secondFileData.length > 0) {
                    Object.keys(secondFileData[0]).forEach(col => columnSet.add(col));
                    populateColumnSelect(Object.keys(secondFileData[0]));
                }
            };
            reader.readAsBinaryString(file);
        }

        function populateColumnSelect(columns) {
            const select = document.getElementById('columnSelect');
            select.innerHTML = '';
            columns.forEach(col => {
                const option = document.createElement('option');
                option.value = col;
                option.textContent = col;
                select.appendChild(option);
            });
        }

        function mergeFiles() {
            if (firstFileData.length === 0 || secondFileData.length === 0) {
                alert("يجب تحميل كلا الملفين للدمج");
                return;
            }
            const mergeColumn = document.getElementById('columnSelect').value;
            let mergedData = {};
            let allColumns = new Set(columnSet);

            [firstFileData, secondFileData].forEach(sheet => {
                sheet.forEach(row => {
                    const key = row[mergeColumn];
                    if (!mergedData[key]) {
                        mergedData[key] = {};
                    }
                    Object.keys(row).forEach(col => {
                        mergedData[key][col] = row[col];
                        allColumns.add(col);
                    });
                });
            });

            displayResults(Object.values(mergedData), [...allColumns], mergeColumn);
        }

        function displayResults(data, columns, mergeColumn) {
            const table = document.getElementById('resultTable');
            table.innerHTML = '';
            
            // Add sequence column
            let headerRow = table.insertRow();
            let thSeq = document.createElement('th');
            thSeq.textContent = 'تسلسل';
            headerRow.appendChild(thSeq);

            columns.forEach(col => {
                let th = document.createElement('th');
                th.textContent = col;
                headerRow.appendChild(th);
            });

            data.forEach((row, index) => {
                let tr = table.insertRow();
                
                // Insert sequence number
                let tdSeq = tr.insertCell();
                tdSeq.textContent = index + 1;
                
                // Check if the row comes from the first file
                if (firstFileData.some(firstFileRow => firstFileRow[mergeColumn] === row[mergeColumn])) {
                    tr.style.backgroundColor = '#dce775'; // لون الخلفية للأسماء من الملف الأول
                }
                
                columns.forEach(col => {
                    let td = tr.insertCell();
                    td.textContent = row[col] || '';
                });
            });
        }
    </script>
</head>
<body>
    <h2>تحميل ملفات Excel</h2>
    <label for="firstFileInput">تحميل الملف الأول الثابت:</label>
    <input type="file" id="firstFileInput" accept=".xlsx, .xls"><br><br>

    <label for="secondFileInput">تحميل الملف الثاني:</label>
    <input type="file" id="secondFileInput" accept=".xlsx, .xls"><br><br>

    <label for="columnSelect">اختر العمود الأساسي للدمج:</label>
    <select id="columnSelect"></select><br><br>

    <button onclick="mergeFiles()">دمج الملفات</button>
    <h3>النتائج:</h3>
    <table border="1" id="resultTable"></table>
</body>
</html>
