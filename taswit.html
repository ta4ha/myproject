<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>دمج ملفات Excel</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        let dataFiles = [];
        let columnSet = new Set();

        document.addEventListener("DOMContentLoaded", function () {
            document.getElementById('fileInput').addEventListener('change', handleFiles);
        });

        function handleFiles(event) {
            const files = event.target.files;
            dataFiles = [];
            columnSet.clear();
            let filesRead = 0;

            Array.from(files).forEach((file) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const workbook = XLSX.read(e.target.result, { type: 'binary' });
                    const sheetName = workbook.SheetNames[0];
                    const sheet = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);
                    
                    if (sheet.length > 0) {
                        dataFiles.push(sheet);
                        Object.keys(sheet[0]).forEach(col => columnSet.add(col));
                    }
                    
                    filesRead++;
                    if (filesRead === files.length) {
                        populateColumnSelect([...columnSet]);
                    }
                };
                reader.readAsBinaryString(file);
            });
        }

        function populateColumnSelect(columns) {
            const select = document.getElementById('columnSelect');
            select.innerHTML = '';
            columns.forEach(col => {
                const option = document.createElement('option');
                option.value = col;
                option.textContent = col;
                select.appendChild(option);
            });
        }

        function mergeFiles() {
            if (dataFiles.length < 2) {
                alert("يجب تحميل ملفين على الأقل للدمج");
                return;
            }
            const mergeColumn = document.getElementById('columnSelect').value;
            let mergedData = {};
            let allColumns = new Set(columnSet);

            dataFiles.forEach(sheet => {
                sheet.forEach(row => {
                    const key = row[mergeColumn];
                    if (!mergedData[key]) {
                        mergedData[key] = {};
                    }
                    Object.keys(row).forEach(col => {
                        mergedData[key][col] = row[col];
                        allColumns.add(col);
                    });
                });
            });

            displayResults(Object.values(mergedData), [...allColumns]);
        }

        function displayResults(data, columns) {
            const table = document.getElementById('resultTable');
            table.innerHTML = '';
            let headerRow = table.insertRow();
            columns.forEach(col => {
                let th = document.createElement('th');
                th.textContent = col;
                headerRow.appendChild(th);
            });
            data.forEach(row => {
                let tr = table.insertRow();
                columns.forEach(col => {
                    let td = tr.insertCell();
                    td.textContent = row[col] || '';
                });
            });
        }
    </script>
</head>
<body>
    <h2>تحميل ملفات Excel</h2>
    <input type="file" id="fileInput" multiple accept=".xlsx, .xls">
    <br>
    <label for="columnSelect">اختر العمود الأساسي للدمج:</label>
    <select id="columnSelect"></select>
    <button onclick="mergeFiles()">دمج الملفات</button>
    <h3>النتائج:</h3>
    <table border="1" id="resultTable"></table>
</body>
</html>