<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>دمج ملفات Excel</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        let firstFileData = [];
        let secondFileData = [];
        let firstFileColumns = [];
        let unmatchedData = [];

        document.addEventListener("DOMContentLoaded", function () {
            document.getElementById('firstFileInput').addEventListener('change', handleFirstFile);
            document.getElementById('secondFileInput').addEventListener('change', handleSecondFile);
        });

        function handleFirstFile(event) {
            const file = event.target.files[0];
            const reader = new FileReader();
            reader.onload = (e) => {
                const workbook = XLSX.read(e.target.result, { type: 'binary' });
                const sheetName = workbook.SheetNames[0];
                firstFileData = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], { raw: true });
                
                if (firstFileData.length > 0) {
                    firstFileColumns = Object.keys(firstFileData[0]);
                }
                
                // Display the first file data as it is
                displayResults(firstFileData, firstFileColumns, 'resultTable');
            };
            reader.readAsBinaryString(file);
        }

        function handleSecondFile(event) {
            const file = event.target.files[0];
            const reader = new FileReader();
            reader.onload = (e) => {
                const workbook = XLSX.read(e.target.result, { type: 'binary' });
                const sheetName = workbook.SheetNames[0];
                secondFileData = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], { raw: true });
                
                if (secondFileData.length > 0) {
                    populateColumnSelect(Object.keys(secondFileData[0]));
                    populateFieldSelection(Object.keys(secondFileData[0]));
                }
            };
            reader.readAsBinaryString(file);
        }

        function populateColumnSelect(columns) {
            const select = document.getElementById('columnSelect');
            select.innerHTML = '';
            columns.forEach(col => {
                const option = document.createElement('option');
                option.value = col;
                option.textContent = col;
                select.appendChild(option);
            });
        }

        function populateFieldSelection(columns) {
            const container = document.getElementById('fieldSelection');
            container.innerHTML = '';
            columns.forEach(col => {
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.value = col;
                checkbox.id = `field-${col}`;
                checkbox.checked = true; // By default, all fields are selected

                const label = document.createElement('label');
                label.htmlFor = `field-${col}`;
                label.textContent = col;

                container.appendChild(checkbox);
                container.appendChild(label);
                container.appendChild(document.createElement('br'));
            });
        }

        function findUnmatched() {
            if (firstFileData.length === 0 || secondFileData.length === 0) {
                alert("يجب تحميل كلا الملفين للبحث عن البيانات غير المطابقة");
                return;
            }
            const mergeColumn = document.getElementById('columnSelect').value;
            unmatchedData = firstFileData.filter(firstRow => 
                !secondFileData.some(secondRow => secondRow[mergeColumn] === firstRow[mergeColumn])
            );

            displayResults(unmatchedData, firstFileColumns, 'unmatchedTable');
        }

        function displayResults(data, columns, tableId) {
            const table = document.getElementById(tableId);
            table.innerHTML = '';
            
            // Add sequence column
            let headerRow = table.insertRow();
            let thSeq = document.createElement('th');
            thSeq.textContent = 'تسلسل';
            headerRow.appendChild(thSeq);

            columns.forEach(col => {
                let th = document.createElement('th');
                th.textContent = col;
                headerRow.appendChild(th);
            });

            data.forEach((row, index) => {
                let tr = table.insertRow();
                
                // Insert sequence number
                let tdSeq = tr.insertCell();
                tdSeq.textContent = index + 1;
                
                columns.forEach(col => {
                    let td = tr.insertCell();
                    td.textContent = row[col] !== undefined ? row[col] : '';
                });
            });
        }
    </script>
</head>
<body>
    <h2>تحميل ملفات Excel</h2>
    <label for="firstFileInput">تحميل الملف الأول الثابت:</label>
    <input type="file" id="firstFileInput" accept=".xlsx, .xls"><br><br>

    <label for="secondFileInput">تحميل الملف الثاني:</label>
    <input type="file" id="secondFileInput" accept=".xlsx, .xls"><br><br>

    <label for="columnSelect">اختر العمود الأساسي للبحث عن البيانات غير المطابقة:</label>
    <select id="columnSelect"></select><br><br>

    <div id="fieldSelection">
        <h3>حدد الحقول التي تريد استخدامها من الملف الثاني:</h3>
    </div>

    <button onclick="findUnmatched()">عرض البيانات غير المطابقة</button>

    <div id="resultTableContainer">
        <h3>البيانات من الملف الثابت:</h3>
        <table border="1" id="resultTable"></table>
    </div>

    <div id="unmatchedTableContainer">
        <h3>البيانات غير المطابقة:</h3>
        <table border="1" id="unmatchedTable"></table>
    </div>
</body>
</html>
